<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Sisters Qiyaam Bingo ğŸŒ™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --midnight: #0a0e27;
  --deep-navy: #111638;
  --royal-purple: #2d1b69;
  --gold: #d4a853;
  --gold-light: #f0d48a;
  --gold-glow: rgba(212, 168, 83, 0.3);
  --teal: #2ec4b6;
  --teal-glow: rgba(46, 196, 182, 0.2);
  --cream: #faf3e0;
  --white: #ffffff;
  --white-soft: rgba(255, 255, 255, 0.85);
  --white-muted: rgba(255, 255, 255, 0.5);
  --star-1: #d4a853;
  --star-2: #2ec4b6;
  --star-3: #e8a0bf;
  --filled-bg: linear-gradient(135deg, #1a3a5c, #2d1b69);
  --filled-border: var(--gold);
  --card-bg: rgba(255, 255, 255, 0.06);
  --card-border: rgba(255, 255, 255, 0.1);
  --danger: #e74c3c;
  --success: #2ecc71;
  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 20px;
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
  --shadow-glow: 0 0 30px var(--gold-glow);
}

*, *::before, *::after {
  margin: 0; padding: 0; box-sizing: border-box;
}

html {
  font-size: 16px;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: var(--font-body);
  background: var(--midnight);
  color: var(--white);
  min-height: 100dvh;
  overflow-x: hidden;
  position: relative;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STARFIELD BACKGROUND
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(1.5px 1.5px at 20% 30%, var(--star-1) 50%, transparent 100%),
    radial-gradient(1px 1px at 40% 70%, var(--star-2) 50%, transparent 100%),
    radial-gradient(1.2px 1.2px at 60% 20%, var(--star-3) 50%, transparent 100%),
    radial-gradient(1px 1px at 80% 60%, var(--star-1) 50%, transparent 100%),
    radial-gradient(1.5px 1.5px at 10% 80%, var(--star-2) 50%, transparent 100%),
    radial-gradient(1px 1px at 70% 90%, var(--star-3) 50%, transparent 100%),
    radial-gradient(1.2px 1.2px at 30% 50%, var(--star-1) 50%, transparent 100%),
    radial-gradient(1px 1px at 90% 10%, var(--star-2) 50%, transparent 100%),
    radial-gradient(1.5px 1.5px at 50% 40%, var(--star-3) 50%, transparent 100%),
    radial-gradient(1px 1px at 15% 55%, var(--star-1) 50%, transparent 100%),
    radial-gradient(1.2px 1.2px at 85% 35%, var(--star-2) 50%, transparent 100%),
    radial-gradient(1px 1px at 45% 85%, var(--star-3) 50%, transparent 100%);
  background-size: 250px 250px;
  animation: twinkle 8s ease-in-out infinite alternate;
  z-index: 0;
  pointer-events: none;
}

@keyframes twinkle {
  0% { opacity: 0.5; }
  50% { opacity: 0.8; }
  100% { opacity: 0.5; }
}

/* Crescent moon decorative */
.moon-decoration {
  position: fixed;
  top: 20px;
  right: 30px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  box-shadow:
    inset -18px -2px 0 0 var(--gold),
    0 0 20px var(--gold-glow),
    0 0 40px rgba(212, 168, 83, 0.15);
  z-index: 1;
  pointer-events: none;
  opacity: 0.8;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.container {
  position: relative;
  z-index: 1;
  max-width: 560px;
  margin: 0 auto;
  padding: 16px;
  min-height: 100dvh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-header {
  text-align: center;
  padding: 24px 0 16px;
}

.app-header h1 {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--gold-light);
  text-shadow: 0 0 20px var(--gold-glow);
  letter-spacing: 0.5px;
  line-height: 1.2;
}

.app-header .subtitle {
  font-size: 0.85rem;
  color: var(--white-muted);
  margin-top: 4px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER BAR (visible to all)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-bar {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 10px 16px;
  margin-bottom: 16px;
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  backdrop-filter: blur(10px);
}

.timer-bar.visible { display: flex; }

.timer-bar .timer-icon { font-size: 1.2rem; }
.timer-bar .timer-display {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--gold-light);
  letter-spacing: 2px;
  min-width: 80px;
  text-align: center;
}

.timer-bar .timer-label {
  font-size: 0.75rem;
  color: var(--white-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.timer-bar.urgent .timer-display { color: var(--danger); animation: pulse-text 1s ease-in-out infinite; }

@keyframes pulse-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen { display: none; }
.screen.active { display: block; animation: fadeIn 0.3s ease; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 80dvh;
  text-align: center;
}

.login-card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-lg);
  padding: 32px 24px;
  width: 100%;
  max-width: 380px;
  backdrop-filter: blur(20px);
}

.login-card h2 {
  font-family: var(--font-display);
  font-size: 1.4rem;
  color: var(--gold-light);
  margin-bottom: 4px;
}

.login-card .login-sub {
  font-size: 0.8rem;
  color: var(--white-muted);
  margin-bottom: 24px;
}

.form-group {
  margin-bottom: 16px;
  text-align: left;
}

.form-group label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--white-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}

.form-group input {
  width: 100%;
  padding: 12px 14px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-sm);
  color: var(--white);
  font-family: var(--font-body);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-group input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px var(--gold-glow);
}

.form-group input::placeholder { color: var(--white-muted); }

/* Date input styling */
.form-group input[type="date"] {
  -webkit-appearance: none;
  color-scheme: dark;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 44px;
  min-width: 44px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--gold), #c49a3a);
  color: var(--midnight);
  width: 100%;
  margin-top: 8px;
  box-shadow: 0 4px 15px var(--gold-glow);
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--gold-glow); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--white);
  border: 1px solid rgba(255,255,255,0.2);
}
.btn-secondary:hover { background: rgba(255,255,255,0.15); }

.btn-danger {
  background: var(--danger);
  color: var(--white);
}

.btn-small { padding: 8px 16px; font-size: 0.8rem; }

.login-error {
  color: var(--danger);
  font-size: 0.8rem;
  margin-top: 8px;
  min-height: 20px;
}

.collision-notice {
  background: rgba(212, 168, 83, 0.15);
  border: 1px solid var(--gold);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: var(--gold-light);
  display: none;
}

.collision-notice.visible { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BINGO BOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.board-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.board-header .player-name {
  font-family: var(--font-display);
  font-size: 1.1rem;
  color: var(--gold-light);
}

.board-header .filled-count {
  font-size: 0.8rem;
  color: var(--teal);
  font-weight: 600;
}

.bingo-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 6px;
  margin-bottom: 20px;
}

.bingo-cell {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 6px 4px;
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  -webkit-user-select: none;
  user-select: none;
}

.bingo-cell:hover:not(.filled):not(.free-space) {
  border-color: var(--gold);
  box-shadow: 0 0 10px var(--gold-glow);
  transform: scale(1.02);
}

.bingo-cell:active:not(.filled):not(.free-space) {
  transform: scale(0.97);
}

.bingo-cell .cell-label {
  font-size: 0.55rem;
  line-height: 1.25;
  color: var(--white-soft);
  font-weight: 500;
  hyphens: auto;
  overflow-wrap: break-word;
  word-break: break-word;
}

.bingo-cell .cell-sister {
  font-size: 0.5rem;
  color: var(--gold-light);
  margin-top: 3px;
  font-weight: 600;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.bingo-cell.filled {
  background: var(--filled-bg);
  border-color: var(--filled-border);
  cursor: default;
  box-shadow: inset 0 0 15px rgba(212, 168, 83, 0.1);
}

.bingo-cell.filled .cell-label {
  color: var(--white);
}

.bingo-cell.filled::after {
  content: 'âœ“';
  position: absolute;
  top: 3px;
  right: 4px;
  font-size: 0.55rem;
  color: var(--gold);
}

.bingo-cell.free-space {
  background: linear-gradient(135deg, var(--royal-purple), #1a3a5c);
  border-color: var(--gold);
  cursor: default;
}

.bingo-cell.free-space .cell-label {
  font-family: var(--font-display);
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--gold-light);
}

/* Win highlight for winning cells */
.bingo-cell.win-cell {
  animation: winPulse 1.5s ease-in-out infinite;
  border-color: var(--gold-light);
  box-shadow: 0 0 15px var(--gold-glow);
}

@keyframes winPulse {
  0%, 100% { box-shadow: 0 0 10px var(--gold-glow); }
  50% { box-shadow: 0 0 25px var(--gold-glow), 0 0 40px rgba(212,168,83,0.15); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL (for entering sister name)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  z-index: 100;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.modal-overlay.visible { display: flex; }

.modal-card {
  background: var(--deep-navy);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-lg);
  padding: 28px 24px;
  width: 100%;
  max-width: 360px;
  animation: modalIn 0.25s ease;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.9) translateY(20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-card h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  color: var(--gold-light);
  margin-bottom: 4px;
}

.modal-card .modal-square-label {
  font-size: 0.85rem;
  color: var(--white-soft);
  margin-bottom: 16px;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--gold);
}

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.modal-actions .btn { flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN BANNER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.win-banner {
  display: none;
  text-align: center;
  padding: 20px;
  margin-bottom: 16px;
  background: linear-gradient(135deg, rgba(212,168,83,0.2), rgba(46,196,182,0.1));
  border: 2px solid var(--gold);
  border-radius: var(--radius-lg);
  animation: winFade 0.5s ease;
}

.win-banner.visible { display: block; }

.win-banner h2 {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--gold-light);
}

.win-banner p {
  font-size: 0.85rem;
  color: var(--white-soft);
  margin-top: 4px;
}

@keyframes winFade {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.admin-section {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  backdrop-filter: blur(10px);
}

.admin-section h3 {
  font-family: var(--font-display);
  font-size: 1rem;
  color: var(--gold-light);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.admin-timer-display {
  font-family: var(--font-display);
  font-size: 3rem;
  font-weight: 700;
  color: var(--gold-light);
  text-align: center;
  margin: 12px 0;
  letter-spacing: 3px;
  text-shadow: 0 0 20px var(--gold-glow);
}

.admin-timer-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.game-mode-selector {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.mode-btn {
  flex: 1;
  min-width: 90px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.06);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  color: var(--white-muted);
  font-family: var(--font-body);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.mode-btn:hover { background: rgba(255,255,255,0.1); }
.mode-btn.active {
  border-color: var(--teal);
  color: var(--teal);
  background: var(--teal-glow);
}

.mode-btn .mode-name { display: block; margin-bottom: 2px; }
.mode-btn .mode-desc { font-size: 0.65rem; font-weight: 400; opacity: 0.7; }

/* Leaderboard */
.leaderboard-list { list-style: none; }

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  transition: background 0.2s;
}

.leaderboard-item:last-child { border-bottom: none; }
.leaderboard-item:hover { background: rgba(255,255,255,0.03); }

.lb-rank {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--white-muted);
  min-width: 28px;
  text-align: center;
}

.lb-rank.gold { color: #ffd700; }
.lb-rank.silver { color: #c0c0c0; }
.lb-rank.bronze { color: #cd7f32; }

.lb-name { flex: 1; font-weight: 500; font-size: 0.9rem; }
.lb-count {
  font-weight: 700;
  color: var(--teal);
  font-size: 0.9rem;
}

.lb-winner {
  background: linear-gradient(135deg, rgba(212,168,83,0.15), rgba(46,196,182,0.05));
  border-radius: var(--radius-sm);
}

.lb-winner .lb-name::after {
  content: ' ğŸ†';
}

.admin-winner-alert {
  display: none;
  text-align: center;
  padding: 16px;
  margin-bottom: 16px;
  background: linear-gradient(135deg, rgba(212,168,83,0.25), rgba(46,196,182,0.15));
  border: 2px solid var(--gold);
  border-radius: var(--radius);
  animation: winPulse 2s ease-in-out infinite;
}

.admin-winner-alert.visible { display: block; }

.admin-winner-alert h3 {
  font-family: var(--font-display);
  color: var(--gold-light);
  justify-content: center;
}

.admin-winner-alert .winner-names {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--teal);
  margin-top: 6px;
}

/* Player count */
.player-count-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--teal-glow);
  color: var(--teal);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.logout-area {
  text-align: center;
  padding: 20px 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-footer {
  text-align: center;
  padding: 16px 0 24px;
  font-size: 0.7rem;
  color: var(--white-muted);
  letter-spacing: 0.5px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 600px) {
  .container { padding: 10px; }
  .app-header h1 { font-size: 1.5rem; }
  .bingo-grid { gap: 4px; }
  .bingo-cell { padding: 4px 3px; }
  .bingo-cell .cell-label { font-size: 0.48rem; }
  .bingo-cell .cell-sister { font-size: 0.42rem; }
  .admin-timer-display { font-size: 2.5rem; }
  .moon-decoration { width: 40px; height: 40px; top: 12px; right: 16px; box-shadow: inset -12px -2px 0 0 var(--gold), 0 0 15px var(--gold-glow); }
}

@media (max-width: 380px) {
  .bingo-grid { gap: 3px; }
  .bingo-cell .cell-label { font-size: 0.42rem; }
  .bingo-cell .cell-sister { font-size: 0.38rem; }
  .login-card { padding: 24px 16px; }
  .app-header h1 { font-size: 1.3rem; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--white-muted);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.screen-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60dvh;
  gap: 12px;
  color: var(--white-muted);
  font-size: 0.85rem;
}

.screen-loading .loading-spinner { width: 36px; height: 36px; border-width: 3px; }

/* Reset game button */
.admin-reset-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid rgba(255,255,255,0.1);
}
</style>
</head>
<body>

<div class="moon-decoration"></div>

<div class="container">
  <!-- HEADER -->
  <header class="app-header">
    <h1>ğŸŒ™ Sisters Qiyaam Bingo</h1>
    <div class="subtitle">Ramadan 2026</div>
  </header>

  <!-- TIMER BAR (global, for all screens) -->
  <div class="timer-bar" id="globalTimerBar">
    <span class="timer-icon">â±</span>
    <div>
      <div class="timer-display" id="globalTimerDisplay">10:00</div>
      <div class="timer-label">Time Remaining</div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="screen active" id="loadingScreen">
    <div class="screen-loading">
      <div class="loading-spinner"></div>
      <span>Loading...</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="screen" id="loginScreen">
    <div class="login-card">
      <h2>Assalamu Alaikum! ğŸ‘‹</h2>
      <p class="login-sub">Enter your info to join the game</p>

      <div class="collision-notice" id="collisionNotice">
        Someone already has that name! Please enter more letters of your last name so we can tell you apart.
      </div>

      <div class="form-group">
        <label for="loginFirst">First Name</label>
        <input type="text" id="loginFirst" placeholder="e.g. Amira" autocomplete="given-name" autocapitalize="words">
      </div>
      <div class="form-group">
        <label for="loginLast" id="loginLastLabel">Last Name Initial</label>
        <input type="text" id="loginLast" placeholder="e.g. S" autocomplete="off" autocapitalize="characters">
      </div>
      <div class="form-group">
        <label for="loginDob">Date of Birth</label>
        <input type="date" id="loginDob">
      </div>

      <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">Join Game âœ¨</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- PLAYER BOARD -->
  <div class="screen" id="boardScreen">
    <div class="win-banner" id="winBanner">
      <h2>ğŸ‰ BINGO! ğŸ‰</h2>
      <p>MashaAllah, you did it!</p>
    </div>

    <div class="board-header">
      <span class="player-name" id="playerName"></span>
      <span class="filled-count" id="filledCount">0/25</span>
    </div>

    <div class="bingo-grid" id="bingoGrid"></div>

    <div class="logout-area">
      <button class="btn btn-secondary btn-small" onclick="logout()">Log Out</button>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="screen" id="adminScreen">
    <div class="admin-winner-alert" id="adminWinnerAlert">
      <h3>ğŸ† We Have a Winner!</h3>
      <div class="winner-names" id="adminWinnerNames"></div>
    </div>

    <!-- Timer Control -->
    <div class="admin-section">
      <h3>â± Timer</h3>
      <div class="admin-timer-display" id="adminTimerDisplay">10:00</div>
      <div class="admin-timer-controls">
        <button class="btn btn-primary btn-small" id="timerStartBtn" onclick="adminStartTimer()">â–¶ Start</button>
        <button class="btn btn-secondary btn-small" id="timerStopBtn" onclick="adminStopTimer()">â¸ Pause</button>
        <button class="btn btn-danger btn-small" onclick="adminResetTimer()">â†º Reset</button>
      </div>
    </div>

    <!-- Game Mode -->
    <div class="admin-section">
      <h3>ğŸ® Game Mode</h3>
      <div class="game-mode-selector" id="gameModeSelector">
        <button class="mode-btn" data-mode="easy" onclick="setGameMode('easy')">
          <span class="mode-name">Easy</span>
          <span class="mode-desc">Corners only</span>
        </button>
        <button class="mode-btn active" data-mode="medium" onclick="setGameMode('medium')">
          <span class="mode-name">Medium</span>
          <span class="mode-desc">Row / Col / Diagonal</span>
        </button>
        <button class="mode-btn" data-mode="hard" onclick="setGameMode('hard')">
          <span class="mode-name">Hard</span>
          <span class="mode-desc">Blackout</span>
        </button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="admin-section">
      <h3>ğŸ† Leaderboard <span class="player-count-badge" id="playerCountBadge">0 players</span></h3>
      <ol class="leaderboard-list" id="leaderboardList">
        <li class="leaderboard-item" style="justify-content:center; color: var(--white-muted); font-size:0.8rem;">No players yet...</li>
      </ol>
    </div>

    <!-- Admin Actions -->
    <div class="admin-section">
      <h3>âš™ Admin</h3>
      <div class="admin-reset-section">
        <button class="btn btn-danger btn-small" onclick="adminResetGame()" style="width:100%">ğŸ—‘ Reset All Game Data</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-secondary btn-small" onclick="logout()" style="width:100%">Log Out</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="squareModal">
    <div class="modal-card">
      <h3>Who did you meet?</h3>
      <div class="modal-square-label" id="modalSquareLabel"></div>
      <div class="form-group">
        <label for="modalSisterName">Sister's Name</label>
        <input type="text" id="modalSisterName" placeholder="e.g. Fatima" autocomplete="off" autocapitalize="words">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitSquare()">Submit âœ“</button>
      </div>
    </div>
  </div>

  <footer class="app-footer">Sisters Qiyaam Bingo Â· v1.0.1</footer>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIREBASE SDK (v9 compat)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âš ï¸  REPLACE THIS with your own Firebase config!
   See setup instructions in the README.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
  apiKey: "AIzaSyBnz3pSV35PeBgHBwY2nblIPVnwZytA2ww",
  authDomain: "sistersbingo-ffcce.firebaseapp.com",
  projectId: "sistersbingo-ffcce",
  storageBucket: "sistersbingo-ffcce.firebasestorage.app",
  messagingSenderId: "6024334326",
  appId: "1:6024334326:web:7d2d821f20fc1285f615d7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SQUARES = [
  "Plays a sport",
  "Has made a Ramadan goal for herself this year",
  "Has a pet",
  "Has a water bottle with them",
  "Prayed taraweeh at ICS earlier tonight",
  "Listens to podcasts",
  "Has an Islamic app on her phone",
  "Is wearing contacts",
  "Has a sweet tooth",
  "Has attended ICS Family Hike before",
  "Moved to DFW less than 5 years ago",
  "Can speak more than 1 language",
  "Ate suhoor this morning",
  "Is wearing your favorite color hijab",
  "Born in the same month as you",
  "Has lived in more than one state",
  "Loves matcha",
  "Loves savory or salty snacks",
  "Crochets, knits, or sews",
  "Has lost her hijab pin or magnet before",
  "Has the same favorite color as you",
  "Is attending her first Qiyaam",
  "Goes to the same school as you",
  "Wears the same shoe size as you"
];

const FREE_SPACE = "Girls Qiyaam 2026";
const ADMIN_FIRST = "Fazena";
const ADMIN_LAST = "B";
const ADMIN_DOB = "2011-01-01";
const TIMER_SECONDS = 600; // 10 minutes

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentPlayer = null; // { id, firstName, lastInitials, dob, board, filledSquares, filledCount }
let isAdmin = false;
let selectedCellIndex = null;
let unsubscribers = [];
let gameSettings = { mode: 'medium', timerEnd: null, timerRunning: false, timerRemaining: TIMER_SECONDS };
let timerInterval = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

function generatePlayerId(first, lastInitials, dob) {
  return `${first.trim().toLowerCase()}_${lastInitials.trim().toLowerCase()}_${dob}`;
}

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function generateBoard() {
  const shuffled = shuffleArray(SQUARES);
  // Insert free space at center (index 12)
  shuffled.splice(12, 0, FREE_SPACE);
  return shuffled.slice(0, 25);
}

function formatTime(seconds) {
  if (seconds < 0) seconds = 0;
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${String(s).padStart(2, '0')}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function cleanup() {
  unsubscribers.forEach(u => { try { u(); } catch(e) {} });
  unsubscribers = [];
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function logout() {
  cleanup();
  currentPlayer = null;
  isAdmin = false;
  selectedCellIndex = null;
  sessionStorage.removeItem('bingo_player_id');
  document.getElementById('globalTimerBar').classList.remove('visible');
  document.getElementById('loginFirst').value = '';
  document.getElementById('loginLast').value = '';
  document.getElementById('loginDob').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('collisionNotice').classList.remove('visible');
  document.getElementById('loginLastLabel').textContent = 'Last Name Initial';
  showScreen('loginScreen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN LOGIC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let collisionRetryCount = 0;

async function handleLogin() {
  const first = document.getElementById('loginFirst').value.trim();
  const lastRaw = document.getElementById('loginLast').value.trim();
  const dob = document.getElementById('loginDob').value;
  const errorEl = document.getElementById('loginError');

  if (!first || !lastRaw || !dob) {
    errorEl.textContent = 'Please fill in all fields.';
    return;
  }

  const lastInitials = lastRaw.toUpperCase();
  errorEl.textContent = '';
  document.getElementById('loginBtn').disabled = true;

  try {
    // Check admin
    if (first === ADMIN_FIRST && lastInitials === ADMIN_LAST && dob === ADMIN_DOB) {
      isAdmin = true;
      sessionStorage.setItem('bingo_player_id', '__admin__');
      document.getElementById('loginBtn').disabled = false;
      showScreen('adminScreen');
      initAdmin();
      return;
    }

    const playerId = generatePlayerId(first, lastInitials, dob);
    const docRef = db.collection('players').doc(playerId);
    const doc = await docRef.get();

    if (doc.exists) {
      // Player already exists, log them in
      currentPlayer = doc.data();
      currentPlayer.id = playerId;
      sessionStorage.setItem('bingo_player_id', playerId);
      document.getElementById('loginBtn').disabled = false;
      showScreen('boardScreen');
      initBoard();
      return;
    }

    // Check for collision â€” someone else with similar base key
    // Actually since the key is unique by first+last+dob, a non-existing doc means fresh player
    // But we should check if someone with same first + single initial + dob exists (collision scenario)
    if (lastInitials.length === 1) {
      // Check if there's already a player with this first + initial + dob
      const existingSnap = await db.collection('players')
        .where('firstName', '==', first)
        .where('dob', '==', dob)
        .get();

      if (!existingSnap.empty) {
        // Collision: ask for more letters
        collisionRetryCount++;
        document.getElementById('collisionNotice').classList.add('visible');
        document.getElementById('loginLastLabel').textContent = `Last Name (first ${collisionRetryCount + 1} letters)`;
        document.getElementById('loginLast').value = '';
        document.getElementById('loginLast').placeholder = `e.g. ${lastInitials}...`;
        document.getElementById('loginLast').focus();
        document.getElementById('loginBtn').disabled = false;
        return;
      }
    }

    // Create new player
    const board = generateBoard();
    const newPlayer = {
      firstName: first,
      lastInitials: lastInitials,
      dob: dob,
      board: board,
      filledSquares: {},
      filledCount: 1 // free space counts
    };

    // Mark free space as filled
    const freeIdx = board.indexOf(FREE_SPACE);
    if (freeIdx !== -1) {
      newPlayer.filledSquares[String(freeIdx)] = 'ğŸŒ™';
    }

    await docRef.set(newPlayer);

    currentPlayer = { ...newPlayer, id: playerId };
    sessionStorage.setItem('bingo_player_id', playerId);
    document.getElementById('loginBtn').disabled = false;
    collisionRetryCount = 0;
    document.getElementById('collisionNotice').classList.remove('visible');
    showScreen('boardScreen');
    initBoard();

  } catch (err) {
    console.error('Login error:', err);
    errorEl.textContent = 'Something went wrong. Please try again.';
    document.getElementById('loginBtn').disabled = false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER BOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initBoard() {
  if (!currentPlayer) return;

  document.getElementById('playerName').textContent = `${escapeHtml(currentPlayer.firstName)} ${escapeHtml(currentPlayer.lastInitials)}`;
  renderGrid();
  startPlayerListeners();
}

function renderGrid() {
  const grid = document.getElementById('bingoGrid');
  grid.innerHTML = '';

  const board = currentPlayer.board;
  const filled = currentPlayer.filledSquares || {};

  for (let i = 0; i < 25; i++) {
    const cell = document.createElement('div');
    cell.className = 'bingo-cell';
    cell.dataset.index = i;

    const label = board[i];
    const isFree = label === FREE_SPACE;
    const isFilled = filled[String(i)] != null;

    if (isFree) {
      cell.classList.add('free-space', 'filled');
      cell.innerHTML = `<span class="cell-label">${escapeHtml(label)}</span>`;
    } else if (isFilled) {
      cell.classList.add('filled');
      cell.innerHTML = `
        <span class="cell-label">${escapeHtml(label)}</span>
        <span class="cell-sister">${escapeHtml(filled[String(i)])}</span>
      `;
    } else {
      cell.innerHTML = `<span class="cell-label">${escapeHtml(label)}</span>`;
      cell.addEventListener('click', () => openModal(i));
    }

    grid.appendChild(cell);
  }

  const count = currentPlayer.filledCount || Object.keys(filled).length;
  document.getElementById('filledCount').textContent = `${count}/25`;
}

function openModal(idx) {
  selectedCellIndex = idx;
  const label = currentPlayer.board[idx];
  document.getElementById('modalSquareLabel').textContent = label;
  document.getElementById('modalSisterName').value = '';
  document.getElementById('squareModal').classList.add('visible');
  setTimeout(() => document.getElementById('modalSisterName').focus(), 100);
}

function closeModal() {
  document.getElementById('squareModal').classList.remove('visible');
  selectedCellIndex = null;
}

async function submitSquare() {
  if (selectedCellIndex === null || !currentPlayer) return;

  const name = document.getElementById('modalSisterName').value.trim();
  if (!name) return;

  const idx = String(selectedCellIndex);
  const playerId = currentPlayer.id;

  try {
    const newFilled = { ...currentPlayer.filledSquares, [idx]: name };
    const newCount = Object.keys(newFilled).length;

    await db.collection('players').doc(playerId).update({
      [`filledSquares.${idx}`]: name,
      filledCount: newCount
    });

    currentPlayer.filledSquares = newFilled;
    currentPlayer.filledCount = newCount;

    closeModal();
    renderGrid();
    checkWinCondition();

  } catch (err) {
    console.error('Submit error:', err);
    alert('Could not save. Please try again.');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN LOGIC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getFilledSet() {
  if (!currentPlayer) return new Set();
  const filled = currentPlayer.filledSquares || {};
  return new Set(Object.keys(filled).map(Number));
}

function checkWinCondition() {
  const filled = getFilledSet();
  const mode = gameSettings.mode || 'medium';
  let won = false;

  if (mode === 'easy') {
    // Corners: 0, 4, 20, 24
    won = [0, 4, 20, 24].every(i => filled.has(i));
  } else if (mode === 'hard') {
    // Blackout
    won = filled.size >= 25;
  } else {
    // Medium: rows, cols, diagonals
    const lines = [
      [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], // rows
      [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], // cols
      [0,6,12,18,24],[4,8,12,16,20] // diagonals
    ];
    won = lines.some(line => line.every(i => filled.has(i)));
  }

  const banner = document.getElementById('winBanner');
  if (won) {
    banner.classList.add('visible');
    // Notify Firestore
    db.collection('players').doc(currentPlayer.id).update({ winner: true }).catch(() => {});
  } else {
    banner.classList.remove('visible');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER LISTENERS (realtime)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startPlayerListeners() {
  cleanup();

  // Listen to own doc for external changes (not common but good practice)
  const unsub1 = db.collection('players').doc(currentPlayer.id).onSnapshot(snap => {
    if (snap.exists) {
      const data = snap.data();
      currentPlayer.filledSquares = data.filledSquares || {};
      currentPlayer.filledCount = data.filledCount || 0;
      renderGrid();
      checkWinCondition();
    }
  });
  unsubscribers.push(unsub1);

  // Listen to game settings (timer, mode)
  const unsub2 = db.collection('game').doc('settings').onSnapshot(snap => {
    if (snap.exists) {
      const data = snap.data();
      gameSettings = { ...gameSettings, ...data };
      updatePlayerTimer();
      checkWinCondition(); // mode may have changed
    }
  });
  unsubscribers.push(unsub2);
}

function updatePlayerTimer() {
  const bar = document.getElementById('globalTimerBar');
  const display = document.getElementById('globalTimerDisplay');

  if (gameSettings.timerRunning && gameSettings.timerEnd) {
    bar.classList.add('visible');
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
      const now = Date.now();
      const end = gameSettings.timerEnd;
      const remaining = Math.max(0, Math.ceil((end - now) / 1000));
      display.textContent = formatTime(remaining);

      if (remaining <= 60) {
        bar.classList.add('urgent');
      } else {
        bar.classList.remove('urgent');
      }

      if (remaining <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        display.textContent = "0:00";
      }
    }, 250);

  } else if (gameSettings.timerRemaining != null && gameSettings.timerRemaining < TIMER_SECONDS) {
    bar.classList.add('visible');
    display.textContent = formatTime(gameSettings.timerRemaining);
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  } else {
    bar.classList.remove('visible');
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initAdmin() {
  startAdminListeners();
}

function startAdminListeners() {
  cleanup();

  // Listen to game settings
  const unsub1 = db.collection('game').doc('settings').onSnapshot(snap => {
    if (snap.exists) {
      const data = snap.data();
      gameSettings = { ...gameSettings, ...data };
    }
    updateAdminUI();
  });
  unsubscribers.push(unsub1);

  // Listen to all players
  const unsub2 = db.collection('players').orderBy('filledCount', 'desc').onSnapshot(snap => {
    renderLeaderboard(snap.docs);
  });
  unsubscribers.push(unsub2);
}

function updateAdminUI() {
  // Game mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === gameSettings.mode);
  });

  // Timer
  const display = document.getElementById('adminTimerDisplay');
  const globalBar = document.getElementById('globalTimerBar');

  if (gameSettings.timerRunning && gameSettings.timerEnd) {
    globalBar.classList.add('visible');
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
      const remaining = Math.max(0, Math.ceil((gameSettings.timerEnd - Date.now()) / 1000));
      display.textContent = formatTime(remaining);
      document.getElementById('globalTimerDisplay').textContent = formatTime(remaining);

      if (remaining <= 60) {
        globalBar.classList.add('urgent');
      } else {
        globalBar.classList.remove('urgent');
      }

      if (remaining <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        // Auto-stop
        db.collection('game').doc('settings').update({
          timerRunning: false,
          timerRemaining: 0
        }).catch(() => {});
      }
    }, 250);
  } else {
    const rem = gameSettings.timerRemaining != null ? gameSettings.timerRemaining : TIMER_SECONDS;
    display.textContent = formatTime(rem);
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

    if (rem < TIMER_SECONDS && rem > 0) {
      globalBar.classList.add('visible');
      document.getElementById('globalTimerDisplay').textContent = formatTime(rem);
    } else if (rem <= 0) {
      globalBar.classList.add('visible');
      document.getElementById('globalTimerDisplay').textContent = "0:00";
    } else {
      globalBar.classList.remove('visible');
    }
  }
}

function renderLeaderboard(docs) {
  const list = document.getElementById('leaderboardList');
  const badge = document.getElementById('playerCountBadge');
  const winAlert = document.getElementById('adminWinnerAlert');
  const winNames = document.getElementById('adminWinnerNames');

  badge.textContent = `${docs.length} player${docs.length !== 1 ? 's' : ''}`;

  if (docs.length === 0) {
    list.innerHTML = '<li class="leaderboard-item" style="justify-content:center; color: var(--white-muted); font-size:0.8rem;">No players yet...</li>';
    winAlert.classList.remove('visible');
    return;
  }

  const winners = [];
  let html = '';

  docs.forEach((doc, i) => {
    const d = doc.data();
    const rank = i + 1;
    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
    const isWinner = d.winner === true;
    const itemClass = isWinner ? 'leaderboard-item lb-winner' : 'leaderboard-item';

    if (isWinner) winners.push(`${d.firstName} ${d.lastInitials}`);

    html += `
      <li class="${itemClass}">
        <span class="lb-rank ${rankClass}">${rank}</span>
        <span class="lb-name">${escapeHtml(d.firstName)} ${escapeHtml(d.lastInitials)}</span>
        <span class="lb-count">${d.filledCount || 0}</span>
      </li>
    `;
  });

  list.innerHTML = html;

  if (winners.length > 0) {
    winAlert.classList.add('visible');
    winNames.textContent = winners.join(', ');
  } else {
    winAlert.classList.remove('visible');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN TIMER CONTROLS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function adminStartTimer() {
  const remaining = gameSettings.timerRemaining != null ? gameSettings.timerRemaining : TIMER_SECONDS;
  if (remaining <= 0) return;

  const timerEnd = Date.now() + (remaining * 1000);

  await db.collection('game').doc('settings').set({
    ...gameSettings,
    timerRunning: true,
    timerEnd: timerEnd,
    timerRemaining: remaining
  }, { merge: true });
}

async function adminStopTimer() {
  if (!gameSettings.timerRunning || !gameSettings.timerEnd) return;

  const remaining = Math.max(0, Math.ceil((gameSettings.timerEnd - Date.now()) / 1000));

  await db.collection('game').doc('settings').set({
    ...gameSettings,
    timerRunning: false,
    timerEnd: null,
    timerRemaining: remaining
  }, { merge: true });
}

async function adminResetTimer() {
  await db.collection('game').doc('settings').set({
    ...gameSettings,
    timerRunning: false,
    timerEnd: null,
    timerRemaining: TIMER_SECONDS
  }, { merge: true });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN GAME MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function setGameMode(mode) {
  await db.collection('game').doc('settings').set({
    ...gameSettings,
    mode: mode
  }, { merge: true });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN RESET GAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function adminResetGame() {
  if (!confirm('Are you sure you want to delete ALL player data and reset the game? This cannot be undone!')) return;
  if (!confirm('Really really sure? All boards and progress will be lost.')) return;

  try {
    // Delete all players
    const snap = await db.collection('players').get();
    const batch = db.batch();
    snap.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // Reset settings
    await db.collection('game').doc('settings').set({
      mode: 'medium',
      timerRunning: false,
      timerEnd: null,
      timerRemaining: TIMER_SECONDS
    });

    alert('Game reset complete!');
  } catch (err) {
    console.error('Reset error:', err);
    alert('Error resetting game.');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT / SESSION RESTORE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  // Try to restore session
  const savedId = sessionStorage.getItem('bingo_player_id');

  if (savedId === '__admin__') {
    isAdmin = true;
    showScreen('adminScreen');
    initAdmin();
    return;
  }

  if (savedId) {
    try {
      const doc = await db.collection('players').doc(savedId).get();
      if (doc.exists) {
        currentPlayer = { ...doc.data(), id: savedId };
        showScreen('boardScreen');
        initBoard();
        return;
      }
    } catch (e) {
      console.error('Session restore error:', e);
    }
  }

  // No session, show login
  showScreen('loginScreen');
}

// Also listen for Enter key on login inputs
document.querySelectorAll('#loginScreen input').forEach(input => {
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
});

// Close modal on overlay click
document.getElementById('squareModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});

// Enter key in modal
document.getElementById('modalSisterName').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitSquare();
});

// Initialize
init();

// Auto-create game settings doc if it doesn't exist
db.collection('game').doc('settings').get().then(snap => {
  if (!snap.exists) {
    db.collection('game').doc('settings').set({
      mode: 'medium',
      timerRunning: false,
      timerEnd: null,
      timerRemaining: TIMER_SECONDS
    });
  }
}).catch(() => {});
</script>
</body>
</html>
